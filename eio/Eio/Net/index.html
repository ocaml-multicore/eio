<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Net (eio.Eio.Net)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">eio</a> &#x00BB; <a href="../index.html">Eio</a> &#x00BB; Net</nav><header class="odoc-preamble"><h1>Module <code><span>Eio.Net</span></code></h1><p>Network sockets and addresses.</p><p>Example:</p><pre class="language-ocaml"><code>let addr = `Tcp (Ipaddr.V4.loopback, 8080)

let http_get ~net ~stdout addr =
  Switch.run @@ fun sw -&gt;
  let flow = Net.connect ~sw net addr in
  Flow.copy_string &quot;GET / HTTP/1.0\r\n\r\n&quot; flow;
  Flow.shutdown flow `Send;
  Flow.copy flow stdout</code></pre></header><nav class="odoc-toc"><ul><li><a href="#types">Types</a></li><li><a href="#out-bound-connections">Out-bound Connections</a></li><li><a href="#incoming-connections">Incoming Connections</a></li><li><a href="#running-servers">Running Servers</a></li><li><a href="#datagram-sockets">Datagram Sockets</a></li><li><a href="#dns-queries">DNS queries</a></li><li><a href="#closing">Closing</a></li><li><a href="#provider-interface">Provider Interface</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-connection_failure"><a href="#type-connection_failure" class="anchor"></a><code><span><span class="keyword">type</span> connection_failure</span><span> = </span></code><ol><li id="type-connection_failure.Refused" class="def variant constructor anchored"><a href="#type-connection_failure.Refused" class="anchor"></a><code><span>| </span><span><span class="constructor">Refused</span> <span class="keyword">of</span> <a href="../Exn/Backend/index.html#type-t">Exn.Backend.t</a></span></code></li><li id="type-connection_failure.No_matching_addresses" class="def variant constructor anchored"><a href="#type-connection_failure.No_matching_addresses" class="anchor"></a><code><span>| </span><span><span class="constructor">No_matching_addresses</span></span></code></li><li id="type-connection_failure.Timeout" class="def variant constructor anchored"><a href="#type-connection_failure.Timeout" class="anchor"></a><code><span>| </span><span><span class="constructor">Timeout</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-error"><a href="#type-error" class="anchor"></a><code><span><span class="keyword">type</span> error</span><span> = </span></code><ol><li id="type-error.Connection_reset" class="def variant constructor anchored"><a href="#type-error.Connection_reset" class="anchor"></a><code><span>| </span><span><span class="constructor">Connection_reset</span> <span class="keyword">of</span> <a href="../Exn/Backend/index.html#type-t">Exn.Backend.t</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>This is a wrapper for epipe, econnreset and similar errors. It indicates that the flow has failed, and data may have been lost.</p><span class="comment-delim">*)</span></div></li><li id="type-error.Connection_failure" class="def variant constructor anchored"><a href="#type-error.Connection_failure" class="anchor"></a><code><span>| </span><span><span class="constructor">Connection_failure</span> <span class="keyword">of</span> <a href="#type-connection_failure">connection_failure</a></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-E"><a href="#extension-decl-E" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../Exn/index.html#type-err">Exn.err</a> += </span></code><ol><li id="extension-E" class="def variant extension anchored"><a href="#extension-E" class="anchor"></a><code><span>| </span><span><span class="extension">E</span> <span class="keyword">of</span> <a href="#type-error">error</a></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-err"><a href="#val-err" class="anchor"></a><code><span><span class="keyword">val</span> err : <span><a href="#type-error">error</a> <span class="arrow">&#45;&gt;</span></span> exn</span></code></div><div class="spec-doc"><p><code>err e</code> is <code>Eio.Exn.create (Net e)</code></p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Ipaddr"><a href="#module-Ipaddr" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Ipaddr/index.html">Ipaddr</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>IP addresses.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Sockaddr"><a href="#module-Sockaddr" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Sockaddr/index.html">Sockaddr</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Network addresses.</p></div></div><h3 id="types"><a href="#types" class="anchor"></a>Types</h3><div class="odoc-spec"><div class="spec type anchored" id="type-socket_ty"><a href="#type-socket_ty" class="anchor"></a><code><span><span class="keyword">type</span> socket_ty</span><span> = </span><span>[ </span></code><ol><li id="type-socket_ty.Socket" class="def variant constructor anchored"><a href="#type-socket_ty.Socket" class="anchor"></a><code><span>| </span><span>`Socket</span></code></li><li id="type-socket_ty.Close" class="def variant constructor anchored"><a href="#type-socket_ty.Close" class="anchor"></a><code><span>| </span><span>`Close</span></code></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-socket"><a href="#type-socket" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a socket</span></span><span> = <span><span>[&gt; <a href="#type-socket_ty">socket_ty</a> ]</span> <span class="keyword">as</span> 'a <a href="../Std/index.html#type-r">Std.r</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-stream_socket_ty"><a href="#type-stream_socket_ty" class="anchor"></a><code><span><span class="keyword">type</span> <span>'tag stream_socket_ty</span></span><span> = </span><span>[ </span></code><ol><li id="type-stream_socket_ty.Stream" class="def variant constructor anchored"><a href="#type-stream_socket_ty.Stream" class="anchor"></a><code><span>| </span><span>`Stream</span></code></li><li id="type-stream_socket_ty.Platform" class="def variant constructor anchored"><a href="#type-stream_socket_ty.Platform" class="anchor"></a><code><span>| </span><span>`Platform <span class="keyword">of</span> <span class="type-var">'tag</span></span></code></li><li id="type-stream_socket_ty.Shutdown" class="def variant constructor anchored"><a href="#type-stream_socket_ty.Shutdown" class="anchor"></a><code><span>| </span><span>`Shutdown</span></code></li><li id="type-stream_socket_ty.socket_ty" class="def variant type anchored"><a href="#type-stream_socket_ty.socket_ty" class="anchor"></a><code><span>| </span><span><a href="#type-socket_ty">socket_ty</a></span></code></li><li id="type-stream_socket_ty.Flow.source_ty" class="def variant type anchored"><a href="#type-stream_socket_ty.Flow.source_ty" class="anchor"></a><code><span>| </span><span><a href="../Flow/index.html#type-source_ty">Flow.source_ty</a></span></code></li><li id="type-stream_socket_ty.Flow.sink_ty" class="def variant type anchored"><a href="#type-stream_socket_ty.Flow.sink_ty" class="anchor"></a><code><span>| </span><span><a href="../Flow/index.html#type-sink_ty">Flow.sink_ty</a></span></code></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-stream_socket"><a href="#type-stream_socket" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a stream_socket</span></span><span> = <span><span class="type-var">'a</span> <a href="../Std/index.html#type-r">Std.r</a></span></span><span> <span class="keyword">constraint</span> <span class="type-var">'a</span> = <span>[&gt; <span><span>[&gt; `Generic ]</span> <a href="#type-stream_socket_ty">stream_socket_ty</a></span> ]</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-listening_socket_ty"><a href="#type-listening_socket_ty" class="anchor"></a><code><span><span class="keyword">type</span> <span>'tag listening_socket_ty</span></span><span> = </span><span>[ </span></code><ol><li id="type-listening_socket_ty.Accept" class="def variant constructor anchored"><a href="#type-listening_socket_ty.Accept" class="anchor"></a><code><span>| </span><span>`Accept</span></code></li><li id="type-listening_socket_ty.Platform" class="def variant constructor anchored"><a href="#type-listening_socket_ty.Platform" class="anchor"></a><code><span>| </span><span>`Platform <span class="keyword">of</span> <span class="type-var">'tag</span></span></code></li><li id="type-listening_socket_ty.socket_ty" class="def variant type anchored"><a href="#type-listening_socket_ty.socket_ty" class="anchor"></a><code><span>| </span><span><a href="#type-socket_ty">socket_ty</a></span></code></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-listening_socket"><a href="#type-listening_socket" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a listening_socket</span></span><span> = <span><span class="type-var">'a</span> <a href="../Std/index.html#type-r">Std.r</a></span></span><span> <span class="keyword">constraint</span> <span class="type-var">'a</span> = <span>[&gt; <span><span>[&gt; `Generic ]</span> <a href="#type-listening_socket_ty">listening_socket_ty</a></span> ]</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-connection_handler"><a href="#type-connection_handler" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a connection_handler</span></span><span> = <span><span><span class="type-var">'a</span> <a href="#type-stream_socket">stream_socket</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="Sockaddr/index.html#type-stream">Sockaddr.stream</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>A <code>_ connection_handler</code> handles incoming connections from a listening socket.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-datagram_socket_ty"><a href="#type-datagram_socket_ty" class="anchor"></a><code><span><span class="keyword">type</span> <span>'tag datagram_socket_ty</span></span><span> = </span><span>[ </span></code><ol><li id="type-datagram_socket_ty.Datagram" class="def variant constructor anchored"><a href="#type-datagram_socket_ty.Datagram" class="anchor"></a><code><span>| </span><span>`Datagram</span></code></li><li id="type-datagram_socket_ty.Platform" class="def variant constructor anchored"><a href="#type-datagram_socket_ty.Platform" class="anchor"></a><code><span>| </span><span>`Platform <span class="keyword">of</span> <span class="type-var">'tag</span></span></code></li><li id="type-datagram_socket_ty.Shutdown" class="def variant constructor anchored"><a href="#type-datagram_socket_ty.Shutdown" class="anchor"></a><code><span>| </span><span>`Shutdown</span></code></li><li id="type-datagram_socket_ty.socket_ty" class="def variant type anchored"><a href="#type-datagram_socket_ty.socket_ty" class="anchor"></a><code><span>| </span><span><a href="#type-socket_ty">socket_ty</a></span></code></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-datagram_socket"><a href="#type-datagram_socket" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a datagram_socket</span></span><span> = <span><span class="type-var">'a</span> <a href="../Std/index.html#type-r">Std.r</a></span></span><span> <span class="keyword">constraint</span> <span class="type-var">'a</span> = <span>[&gt; <span><span>[&gt; `Generic ]</span> <a href="#type-datagram_socket_ty">datagram_socket_ty</a></span> ]</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-ty"><a href="#type-ty" class="anchor"></a><code><span><span class="keyword">type</span> <span>'tag ty</span></span><span> = </span><span>[ </span></code><ol><li id="type-ty.Network" class="def variant constructor anchored"><a href="#type-ty.Network" class="anchor"></a><code><span>| </span><span>`Network</span></code></li><li id="type-ty.Platform" class="def variant constructor anchored"><a href="#type-ty.Platform" class="anchor"></a><code><span>| </span><span>`Platform <span class="keyword">of</span> <span class="type-var">'tag</span></span></code></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a t</span></span><span> = <span><span class="type-var">'a</span> <a href="../Std/index.html#type-r">Std.r</a></span></span><span> <span class="keyword">constraint</span> <span class="type-var">'a</span> = <span>[&gt; <span><span>[&gt; `Generic ]</span> <a href="#type-ty">ty</a></span> ]</span></span></code></div></div><h3 id="out-bound-connections"><a href="#out-bound-connections" class="anchor"></a>Out-bound Connections</h3><div class="odoc-spec"><div class="spec value anchored" id="val-connect"><a href="#val-connect" class="anchor"></a><code><span><span class="keyword">val</span> connect : 
  <span><span class="label">sw</span>:<a href="../Switch/index.html#type-t">Switch.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>[&gt; <span><span class="type-var">'tag</span> <a href="#type-ty">ty</a></span> ]</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Sockaddr/index.html#type-stream">Sockaddr.stream</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'tag</span> <a href="#type-stream_socket_ty">stream_socket_ty</a></span> <a href="../Std/index.html#type-r">Std.r</a></span></span></code></div><div class="spec-doc"><p><code>connect ~sw t addr</code> is a new socket connected to remote address <code>addr</code>.</p><p>The new socket will be closed when <code>sw</code> finishes, unless closed manually first.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_tcp_connect"><a href="#val-with_tcp_connect" class="anchor"></a><code><span><span class="keyword">val</span> with_tcp_connect : 
  <span><span class="optlabel">?timeout</span>:<a href="../Time/Timeout/index.html#type-t">Time.Timeout.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">host</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">service</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>[&gt; <span><span class="type-var">'tag</span> <a href="#type-ty">ty</a></span> ]</span> <a href="../Std/index.html#type-r">Std.r</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span><span><span class="type-var">'tag</span> <a href="#type-stream_socket_ty">stream_socket_ty</a></span> <a href="../Std/index.html#type-r">Std.r</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'b</span></span></code></div><div class="spec-doc"><p><code>with_tcp_connect ~host ~service t f</code> creates a tcp connection <code>conn</code> to <code>host</code> and <code>service</code> and executes <code>f conn</code>.</p><p><code>conn</code> is closed after <code>f</code> returns (if it isn't already closed by then).</p><p><code>host</code> is either an IP address or a domain name, eg. &quot;www.example.org&quot;, &quot;www.ocaml.org&quot; or &quot;127.0.0.1&quot;.</p><p><code>service</code> is an IANA recognized service name or port number, eg. &quot;http&quot;, &quot;ftp&quot;, &quot;8080&quot; etc. See https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml.</p><p>Addresses are tried in the order they are returned by <a href="#val-getaddrinfo"><code>getaddrinfo</code></a>, until one succeeds.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">timeout</span> <p>Limits how long to wait for each connection attempt before moving on to the next. By default there is no timeout (beyond what the underlying network does).</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="#type-error.Connection_failure"><code>Connection_failure</code></a> <p>A connection couldn't be established for any of the addresses defined for <code>host</code>.</p></li></ul></div></div><h3 id="incoming-connections"><a href="#incoming-connections" class="anchor"></a>Incoming Connections</h3><div class="odoc-spec"><div class="spec value anchored" id="val-listen"><a href="#val-listen" class="anchor"></a><code><span><span class="keyword">val</span> listen : 
  <span><span class="optlabel">?reuse_addr</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?reuse_port</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">backlog</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">sw</span>:<a href="../Switch/index.html#type-t">Switch.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>[&gt; <span><span class="type-var">'tag</span> <a href="#type-ty">ty</a></span> ]</span> <a href="../Std/index.html#type-r">Std.r</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Sockaddr/index.html#type-stream">Sockaddr.stream</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'tag</span> <a href="#type-listening_socket_ty">listening_socket_ty</a></span> <a href="../Std/index.html#type-r">Std.r</a></span></span></code></div><div class="spec-doc"><p><code>listen ~sw ~backlog t addr</code> is a new listening socket bound to local address <code>addr</code>.</p><p>The new socket will be closed when <code>sw</code> finishes, unless closed manually first.</p><p>On platforms that support this, passing port <code>0</code> will bind to a random port.</p><p>For (non-abstract) Unix domain sockets, the path will be removed afterwards.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">backlog</span> <p>The number of pending connections that can be queued up (see listen(2)).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">reuse_addr</span> <p>Set the <code>Unix.SO_REUSEADDR</code> socket option. For Unix paths, also remove any stale left-over socket.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">reuse_port</span> <p>Set the <code>Unix.SO_REUSEPORT</code> socket option.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-accept"><a href="#val-accept" class="anchor"></a><code><span><span class="keyword">val</span> accept : 
  <span><span class="label">sw</span>:<a href="../Switch/index.html#type-t">Switch.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>[&gt; <span><span class="type-var">'tag</span> <a href="#type-listening_socket_ty">listening_socket_ty</a></span> ]</span> <a href="../Std/index.html#type-r">Std.r</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'tag</span> <a href="#type-stream_socket_ty">stream_socket_ty</a></span> <a href="../Std/index.html#type-r">Std.r</a></span> * <a href="Sockaddr/index.html#type-stream">Sockaddr.stream</a></span></code></div><div class="spec-doc"><p><code>accept ~sw socket</code> waits until a new connection is ready on <code>socket</code> and returns it.</p><p>The new socket will be closed automatically when <code>sw</code> finishes, if not closed earlier. If you want to handle multiple connections, consider using <a href="#val-accept_fork"><code>accept_fork</code></a> instead.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-accept_fork"><a href="#val-accept_fork" class="anchor"></a><code><span><span class="keyword">val</span> accept_fork : 
  <span><span class="label">sw</span>:<a href="../Switch/index.html#type-t">Switch.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>[&gt; <span><span class="type-var">'tag</span> <a href="#type-listening_socket_ty">listening_socket_ty</a></span> ]</span> <a href="../Std/index.html#type-r">Std.r</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">on_error</span>:<span>(<span>exn <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>[&lt; <span><span class="type-var">'tag</span> <a href="#type-stream_socket_ty">stream_socket_ty</a></span> ]</span> <a href="#type-connection_handler">connection_handler</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>accept_fork ~sw ~on_error socket fn</code> accepts a connection and handles it in a new fiber.</p><p>After accepting a connection to <code>socket</code>, it runs <code>fn flow client_addr</code> in a new fiber.</p><p><code>flow</code> will be closed when <code>fn</code> returns. The new fiber is attached to <code>sw</code>.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">on_error</span> <p>Called if <code>connection_handler</code> raises an exception. This is typically a good place to log the error and continue. If the exception is an <a href="../index.html#exception-Io"><code>Eio.Io</code></a> error then the caller's address is added to it.</p><p>If you don't want to handle connection errors, use <code>~on_error:raise</code> to cancel the caller's context.</p><p><code>on_error</code> is not called for <a href="../Cancel/index.html#exception-Cancelled"><code>Cancel.Cancelled</code></a> exceptions, which do not need to be reported.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-listening_addr"><a href="#val-listening_addr" class="anchor"></a><code><span><span class="keyword">val</span> listening_addr : <span><span><span>[&gt; <span><span class="type-var">'tag</span> <a href="#type-listening_socket_ty">listening_socket_ty</a></span> ]</span> <a href="../Std/index.html#type-r">Std.r</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="Sockaddr/index.html#type-stream">Sockaddr.stream</a></span></code></div></div><h3 id="running-servers"><a href="#running-servers" class="anchor"></a>Running Servers</h3><div class="odoc-spec"><div class="spec value anchored" id="val-run_server"><a href="#val-run_server" class="anchor"></a><code><span><span class="keyword">val</span> run_server : 
  <span><span class="optlabel">?max_connections</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?additional_domains</span>:<span>(<span><span class="type-var">_</span> <a href="../Domain_manager/index.html#type-t">Domain_manager.t</a></span> * int)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?stop</span>:<span><span class="type-var">'a</span> <a href="../Promise/index.html#type-t">Promise.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">on_error</span>:<span>(<span>exn <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>[&gt; <span><span class="type-var">'tag</span> <a href="#type-listening_socket_ty">listening_socket_ty</a></span> ]</span> <a href="../Std/index.html#type-r">Std.r</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>[&lt; <span><span class="type-var">'tag</span> <a href="#type-stream_socket_ty">stream_socket_ty</a></span> ]</span> <a href="#type-connection_handler">connection_handler</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>run_server ~on_error sock connection_handler</code> establishes a concurrent socket server <code>s</code>.</p><p>It accepts incoming client connections on socket <code>sock</code> and handles them with <a href="#val-accept_fork"><code>accept_fork</code></a> (see that for the description of <code>on_error</code> and <code>connection_handler</code>).</p><p><b>Running a Parallel Server</b></p><p>By default <code>s</code> runs on a <em>single</em> OCaml <code>Domain</code>. However, if <code>additional_domains:(domain_mgr, domains)</code> parameter is given, then <code>s</code> will spawn <code>domains</code> additional domains and run accept loops in those too. In such cases you must ensure that <code>connection_handler</code> only accesses thread-safe values. Note that having more than <code>Domain.recommended_domain_count</code> domains in total is likely to result in bad performance.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">max_connections</span> <p>The maximum number of concurrent connections accepted by <code>s</code> at any time. The default is <code>Int.max_int</code>.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">stop</span> <p>Resolving this promise causes <code>s</code> to stop accepting new connections. <code>run_server</code> will wait for all existing connections to finish and then return. This is useful to upgrade a server without clients noticing. To stop immediately, cancelling all connections, just cancel <code>s</code>'s fiber instead.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">on_error</span> <p>Connection error handler (see <a href="#val-accept_fork"><code>accept_fork</code></a>).</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_argument</code> <p>if <code>max_connections &lt;= 0</code>. if <code>additional_domains = (domain_mgr, domains)</code> is used and <code>domains &lt; 0</code>.</p></li></ul></div></div><h3 id="datagram-sockets"><a href="#datagram-sockets" class="anchor"></a>Datagram Sockets</h3><div class="odoc-spec"><div class="spec value anchored" id="val-datagram_socket"><a href="#val-datagram_socket" class="anchor"></a><code><span><span class="keyword">val</span> datagram_socket : 
  <span><span class="optlabel">?reuse_addr</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?reuse_port</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">sw</span>:<a href="../Switch/index.html#type-t">Switch.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>[&gt; <span><span class="type-var">'tag</span> <a href="#type-ty">ty</a></span> ]</span> <a href="../Std/index.html#type-r">Std.r</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[&lt; <a href="Sockaddr/index.html#type-datagram">Sockaddr.datagram</a> <span>| `UdpV4</span> <span>| `UdpV6</span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'tag</span> <a href="#type-datagram_socket_ty">datagram_socket_ty</a></span> <a href="../Std/index.html#type-r">Std.r</a></span></span></code></div><div class="spec-doc"><p><code>datagram_socket ~sw t addr</code> creates a new datagram socket bound to <code>addr</code>. The new socket will be closed when <code>sw</code> finishes.</p><p><code>`UdpV4</code> and <code>`UdpV6</code> represents IPv4 and IPv6 datagram client sockets where the OS assigns the next available socket address and port automatically. <code>`Udp ..</code> can be used to create both listening server socket and client socket.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">reuse_addr</span> <p>Set the <code>Unix.SO_REUSEADDR</code> socket option.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">reuse_port</span> <p>Set the <code>Unix.SO_REUSEPORT</code> socket option.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-send"><a href="#val-send" class="anchor"></a><code><span><span class="keyword">val</span> send : 
  <span><span><span class="type-var">_</span> <a href="#type-datagram_socket">datagram_socket</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?dst</span>:<a href="Sockaddr/index.html#type-datagram">Sockaddr.datagram</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="xref-unresolved">Cstruct</span>.t list</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>send sock buf</code> sends the data in <code>buf</code> using the the datagram socket <code>sock</code>.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">dst</span> <p>If <code>sock</code> isn't connected, this provides the destination.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-recv"><a href="#val-recv" class="anchor"></a><code><span><span class="keyword">val</span> recv : <span><span><span class="type-var">_</span> <a href="#type-datagram_socket">datagram_socket</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Cstruct</span>.t <span class="arrow">&#45;&gt;</span></span> <a href="Sockaddr/index.html#type-datagram">Sockaddr.datagram</a> * int</span></code></div><div class="spec-doc"><p><code>recv sock buf</code> receives data from the socket <code>sock</code> putting it in <code>buf</code>. The number of bytes received is returned along with the sender address and port. If the <code>buf</code> is too small then excess bytes may be discarded depending on the type of the socket the message is received from.</p></div></div><h3 id="dns-queries"><a href="#dns-queries" class="anchor"></a>DNS queries</h3><div class="odoc-spec"><div class="spec value anchored" id="val-getaddrinfo"><a href="#val-getaddrinfo" class="anchor"></a><code><span><span class="keyword">val</span> getaddrinfo : <span><span class="optlabel">?service</span>:string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="Sockaddr/index.html#type-t">Sockaddr.t</a> list</span></span></code></div><div class="spec-doc"><p><code>getaddrinfo ?service t node</code> returns a list of IP addresses for <code>node</code>. <code>node</code> is either a domain name or an IP address.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">service</span> <p>is a human friendly textual name for internet services assigned by IANA., eg. 'http', 'https', 'ftp', etc.</p><p>For a more thorough treatment, see <a href="https://man7.org/linux/man-pages/man3/getaddrinfo.3.html">getaddrinfo</a>.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-getaddrinfo_stream"><a href="#val-getaddrinfo_stream" class="anchor"></a><code><span><span class="keyword">val</span> getaddrinfo_stream : 
  <span><span class="optlabel">?service</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Sockaddr/index.html#type-stream">Sockaddr.stream</a> list</span></span></code></div><div class="spec-doc"><p><code>getaddrinfo_stream</code> is like <a href="#val-getaddrinfo"><code>getaddrinfo</code></a>, but filters out non-stream protocols.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-getaddrinfo_datagram"><a href="#val-getaddrinfo_datagram" class="anchor"></a><code><span><span class="keyword">val</span> getaddrinfo_datagram : 
  <span><span class="optlabel">?service</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Sockaddr/index.html#type-datagram">Sockaddr.datagram</a> list</span></span></code></div><div class="spec-doc"><p><code>getaddrinfo_datagram</code> is like <a href="#val-getaddrinfo"><code>getaddrinfo</code></a>, but filters out non-datagram protocols.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-getnameinfo"><a href="#val-getnameinfo" class="anchor"></a><code><span><span class="keyword">val</span> getnameinfo : <span><span><span class="type-var">_</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="Sockaddr/index.html#type-t">Sockaddr.t</a> <span class="arrow">&#45;&gt;</span></span> string * string</span></code></div><div class="spec-doc"><p><code>getnameinfo t sockaddr</code> is <code>(hostname, service)</code> corresponding to <code>sockaddr</code>. <code>hostname</code> is the registered domain name represented by <code>sockaddr</code>. <code>service</code> is the IANA specified textual name of the port specified in <code>sockaddr</code>, e.g. 'ftp', 'http', 'https', etc.</p></div></div><h3 id="closing"><a href="#closing" class="anchor"></a>Closing</h3><div class="odoc-spec"><div class="spec value anchored" id="val-close"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><span><span>[&gt; `Close ]</span> <a href="../Std/index.html#type-r">Std.r</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Alias of <a href="../Resource/index.html#val-close"><code>Resource.close</code></a>.</p></div></div><h3 id="provider-interface"><a href="#provider-interface" class="anchor"></a>Provider Interface</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Pi"><a href="#module-Pi" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Pi/index.html">Pi</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
